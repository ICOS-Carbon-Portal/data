@import akka.http.scaladsl.model.Uri
@import se.lu.nateko.cp.meta.core.crypto.Sha256Sum
@import se.lu.nateko.cp.meta.core.data.Envri
@import se.lu.nateko.cp.meta.core.data.Envri.Envri
@import se.lu.nateko.cp.meta.core.data.Envri.EnvriConfigs
@import se.lu.nateko.cp.meta.core.HandleProxiesConfig
@import se.lu.nateko.cp.data.routes.LicenceRouting._

@(profile: LicenceProfile, loginUri: Option[Uri], handleProxies: HandleProxiesConfig)(implicit envri: Envri, envriConfigs: EnvriConfigs)

@template{
	<style>@LicenceStyle()</style>
	<style type="text/css">
		details{
			border: 1px solid #ddd;
			border-radius: 3px;
			margin-bottom: 20px;
		}
		details summary{
			padding: 15px;
			font-size: 20px;
			text-align: center;
			cursor: pointer;
			background-color: #f5f5f5;
		}
		details summary:hover{
			background-color:#d5d5d5;
		}
		details summary img{
			height: 50px;
		}
		details summary h4{
			font-size: 20px;
			margin-top: 15px;
			margin-bottom: 0;
		}
		details div{
			padding: 15px;
		}
	</style>

	<script type="application/javascript">
			function toggleAccordion(btn) {
				if (Array.from(btn.classList).includes("collapsed"))
					openAccordion(btn);
				else
					closeAccordion(btn);
			}

			function openAccordion(btn) {
				btn.classList.remove("collapsed");
				const bodySection = btn.parentNode.nextElementSibling;
				bodySection.classList.remove("collapse");
				bodySection.classList.add("collapsing");

				const complete = () => {
					bodySection.classList.remove("collapsing");
					bodySection.classList.add("collapse", "show");

					bodySection.style.height = "";
					bodySection.removeEventListener('transitionend', complete);
				}

				bodySection.addEventListener('transitionend', complete);
				bodySection.style.height = bodySection.scrollHeight + "px";
			}

			function closeAccordion(btn) {
				btn.classList.add("collapsed");
				btn.parentNode.nextElementSibling.classList.remove("show");
			}
	</script>
}{
<div class="cp_page_container">

<div class="cp_page_header">
	<h1>@pageTitle</h1>
</div>

<div class="col_1">
  <div class="inner">
    <h4><img src="https://www.icos-cp.eu/sites/default/files/inline-images/creativecommons.png" style="margin-right:10px" />
			@name data is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 international licence</a></h4>
  </div>
</div>

	@licenceText

	@for(userLoginUri <- loginUri){
		<div class="col-sm-12 col-md-6 col-md-offset-3">
			<div class="link_box inner">
				<a href=@{userLoginUri} target="_blank"><h5>Log in to accept permanently</h5></a>
			</div>
		</div>
	}

	@profile match{
		case uris: UriLicenceProfile => {
			@for(licenceAcceptUri <- uris.licenceAcceptUri){
				@acceptLicence{
					@yesNoButtonsDiv{
						<a id="downloadBtn" class="btn btn-primary btn-lg btn-licence" href=@{licenceAcceptUri}>Yes, I accept</a>
					}
				}
			}
		}
		case forms: FormLicenceProfile =>{
			@for(formInfo <- forms.formInfo){
				@acceptLicence{
					<form action="/objects" method="post">
						@for((name, value) <- formInfo){
							<input type="hidden" name="@name" value="@value" />
						}
						@yesNoButtonsDiv{
							<button id="downloadBtn" class="btn btn-primary btn-lg btn-licence">Yes, I accept</button>
						}
					</form>
				}
			}
		}
	}

</div>

}

@licenceText = @{
	if(envri == Envri.SITES) LicenceSitesText() else LicenceIcosText(handleProxies)
}

@acceptLicence(yesNoButtons: Html) = {
	<div class="row">
		<div class="col-sm-6 col-md-5 mt-4 fs-5">
			<div class="form-check form-switch">
				<input id="agreementChkBx" class="form-check-input" type="checkbox">
				<label class="form-check-label" for="agreementChkBx">
					I hereby confirm that I have taken notice of the information provided to inform me about the
					data and good practices of data usage. These guidelines do not define additional contractual
					conditions.
				</label>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-sm-6 col-md-4">
			@yesNoButtons
		</div>
	</div>
}

@yesNoButtonsDiv(yesButton: Html) = {
	<div>
		@yesButton
		<a id="cancelBtn" class="btn btn-default btn-lg btn-licence" style="display:none;" href="javascript:window.history.go(-1);">Go back</a>
		<script type="application/javascript">
			const downloadBtn = document.getElementById("downloadBtn");

			function toggleBtn(disabled){
				if (disabled){
					downloadBtn.setAttribute("disabled", disabled.toString());
					downloadBtn.setAttribute("class", "btn btn-primary btn-lg btn-licence disabled");
				} else {
					downloadBtn.removeAttribute("disabled");
					downloadBtn.setAttribute("class", "btn btn-primary btn-lg btn-licence");
				}
			}

			window.addEventListener("load", () => {
				downloadBtn.innerHTML = "Download";

				const cancelBtn = document.getElementById("cancelBtn");
				cancelBtn.setAttribute("style", "display: inline-block;");

				const agreementChkBx = document.getElementById("agreementChkBx");
				agreementChkBx.addEventListener("click", function(){
					toggleBtn(!this.checked);
				});

				toggleBtn(true);
			});

		</script>
	</div>
}

@template = @{
	if(envri == Envri.SITES) SitesPage(pageTitle, authHost = conf.authHost, dataHost = conf.dataHost) _
	else CpCommonPage(pageTitle, authHost = conf.authHost, dataHost = conf.dataHost) _
}

@pageTitle = @{
	if(envri == Envri.SITES) name + " Data Policy" else name + " Data Licence"
}

@name = @{
	envri.toString
}

@conf = @{envriConfigs(envri)}
