akka{
	loggers = ["akka.event.slf4j.Slf4jLogger"]
	logging-filter = "akka.event.slf4j.Slf4jLoggingFilter"

	http.server.parsing{
		max-content-length = 128g
		max-uri-length = 64k
	}
	log-dead-letters = 1
	log-dead-letters-during-shutdown = off
}

cpdata{
	interface = "127.0.0.1"
	auth {
		ICOS: ${cpauthAuthPub} //substituted from cpauth core config
		SITES: ${fieldsitesAuthPub} //substituted from cpauth core config
	}
	netcdf {
		folder = "/disk/data/common/netcdf/dataDemo/"
		dateVars = ["date", "mtime", "time", "tstep"]
		latitudeVars = ["latitude", "lat"]
		longitudeVars = ["longitude", "lon"]
		elevationVars = ["nz"]
	}
	meta {
		baseUrl = "http://127.0.0.1:9094/"
		sparqlEndpointPath = "sparql"
		uploadApiPath = "upload"
	}
	upload {
		folder: "./fileStorage"
		irods {
			host: "130.237.230.190"
			port: 1247
			username: "oleg"
			password: "password"
			homeDirectory: "/eudat.se/projects/icos"
			zone: "eudat.se"
			defaultResource: "EUDAT"
			dryRun: false
		}
		irods2 {
			host: "irods-login.swestore.se"
			port: 2432,
			username: "s_olemi"
			password: "password"
			homeDirectory: "/snic.se/projects/icos"
			zone: "snic.se"
			defaultResource: "pdc-gpfs"
			authenticationScheme: "PAM"
			dryRun: false
		}
		b2stage {
			host: "https://b2safe3.csc.fi"
			username: "oleg"
			password: "password"
		}
	}
	stilt {
		mainFolder = "/disk/data/STILT/"
	}

	restheart{
		baseUri = "http://127.0.0.1:8088"
		dbNames {
			ICOS: "db"
			SITES: "sitesdb"
		}
		dobjDownloadLogUris{
			ICOS: "https://cpauth.icos-cp.eu/logs/dobjdls"
			SITES: "https://auth.fieldsites.se/logs/dobjdls"
		}
		usersCollection = "users"
		portalUsageCollection = "portaluse"
		dobjDownloadsCollection = "dobjdls"
		dobjDownloadsAggregations = {
			"aggrs":[{
				"uri": "downloadsByCountry",
				"type": "pipeline",
				"stages":[
					{"$match": {
						"$and": [
							{"dobj.specification.self.uri": {"$in": {"$var": "specification"}}},
							{"dobj.specification.format.uri": {"$in": {"$var": "format" }}},
							{"dobj.specification.dataLevel": {"$in": {"$var": "dataLevel"}}},
							{"dobj.specificInfo.acquisition.station.name": {"$in": {"$var": "stations"}}},
							{"$or": [
								{"dobj.specificInfo.productionInfo.creator.self.uri": {"$in": {"$var": "contributors"}}},
								{"dobj.specificInfo.productionInfo.contributors.self.uri": {"$in": {"$var": "contributors"}}}
							]},
							{"$or": [
								{"dobj.specificInfo.acquisition.station.theme": {"$in": {"$var": "themes"}}},
								{"dobj.specificInfo.theme": {"$in": {"$var": "themes"}}}
							]},
						]
					}},
					{"_$group": {
						"_id": "$country_code",
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"count": -1}}
				]
			}, {
				"uri": "downloadsPerWeek",
				"type": "pipeline",
				"stages":[
					{"$match": {
						"$and": [
							{"dobj.specification.self.uri": {"$in": {"$var": "specification"}}},
							{"dobj.specification.format.uri": {"$in": {"$var": "format" }}},
							{"dobj.specification.dataLevel": {"$in": {"$var": "dataLevel"}}},
							{"dobj.specificInfo.acquisition.station.name": {"$in": {"$var": "stations"}}},
							{"$or": [
								{"dobj.specificInfo.productionInfo.creator.self.uri": {"$in": {"$var": "contributors"}}},
								{"dobj.specificInfo.productionInfo.contributors.self.uri": {"$in": {"$var": "contributors"}}}
							]},
							{"$or": [
								{"dobj.specificInfo.acquisition.station.theme": {"$in": {"$var": "themes"}}},
								{"dobj.specificInfo.theme": {"$in": {"$var": "themes"}}}
							]},
						]
					}},
					{"_$group": {
						"_id": {"$dateFromParts": {"isoWeekYear": {"_$isoWeekYear": "$_id"}, "isoWeek": {"_$isoWeek": "$_id"}}},
						"week": {"$first": {"_$isoWeek": "$_id"}},
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"_id": 1}}
				]
			}, {
				"uri": "downloadsPerMonth",
				"type": "pipeline",
				"stages":[
					{"$match": {
						"$and": [
							{"dobj.specification.self.uri": {"$in": {"$var": "specification"}}},
							{"dobj.specification.format.uri": {"$in": {"$var": "format" }}},
							{"dobj.specification.dataLevel": {"$in": {"$var": "dataLevel"}}},
							{"dobj.specificInfo.acquisition.station.name": {"$in": {"$var": "stations"}}},
							{"$or": [
								{"dobj.specificInfo.productionInfo.creator.self.uri": {"$in": {"$var": "contributors"}}},
								{"dobj.specificInfo.productionInfo.contributors.self.uri": {"$in": {"$var": "contributors"}}}
							]},
							{"$or": [
								{"dobj.specificInfo.acquisition.station.theme": {"$in": {"$var": "themes"}}},
								{"dobj.specificInfo.theme": {"$in": {"$var": "themes"}}}
							]},
						]
					}},
					{"_$group": {
						"_id": {"$dateFromParts": {"year": {"_$year": "$_id"}, "month": {"_$month": "$_id"}}},
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"_id": 1}}
				]
			}, {
				"uri": "downloadsPerYear",
				"type": "pipeline",
				"stages":[
					{"$match": {
						"$and": [
							{"dobj.specification.self.uri": {"$in": {"$var": "specification"}}},
							{"dobj.specification.format.uri": {"$in": {"$var": "format" }}},
							{"dobj.specification.dataLevel": {"$in": {"$var": "dataLevel"}}},
							{"dobj.specificInfo.acquisition.station.name": {"$in": {"$var": "stations"}}},
							{"$or": [
								{"dobj.specificInfo.productionInfo.creator.self.uri": {"$in": {"$var": "contributors"}}},
								{"dobj.specificInfo.productionInfo.contributors.self.uri": {"$in": {"$var": "contributors"}}}
							]},
							{"$or": [
								{"dobj.specificInfo.acquisition.station.theme": {"$in": {"$var": "themes"}}},
								{"dobj.specificInfo.theme": {"$in": {"$var": "themes"}}}
							]},
						]
					}},
					{"_$group": {
						"_id": {"$dateFromParts": {"year": {"_$year": "$_id"}}},
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"_id": 1}}
				]
			}, {
				"uri": "downloadCounts",
				"type": "pipeline",
				"stages":[
					{"_$group": {
						"_id": {"_$concat": ["https://meta.icos-cp.eu/objects/", {"_$substr": ["$dobj.hash", 0, 24]}]},
						"fileName": {"_$first": "$dobj.fileName"},
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"count": -1}}
				]
			}, {
				"uri": "getCreatorsAndContributors",
				"type": "pipeline",
				"stages": [{
					"_$project": {
						"cont": {
							"_$concatArrays": [
								"_$dobj.specificInfo.productionInfo.contributors.self.uri",
								["$_dobj.specificInfo.productionInfo.creator.self.uri"]
							]
						},
						"dataLvl": "_$dobj.specification.dataLevel",
						"dobj.specification.dataLevel": "1",
						"dobj.specificInfo.acquisition.station.org.self.uri": "1"
					}
				}, {
					"_$project": {
						"dataproviders": {
							"_$cond": [
								{"_$eq": ["_$dobj.specification.dataLevel", "0"]},
								"_$dobj.specificInfo.acquisition.station.org.self.uri",
								"_$cont"
							]
						}
					}
				}, {
					"_$unwind" : "_$dataproviders"
				}, {
					"_$group": {"_id" : "_$dataproviders", "count" : {"_$sum" : 1}}
				}]
			}, {
				"uri": "getDownloadStats",
				"type": "pipeline",
				"stages": [
					{"$match": {
					  "$and": [
					    {"dobj.specification.self.uri": {"$in": {"$var": "specification"}}},
					    {"dobj.specification.format.uri": {"$in": {"$var": "format" }}},
							{"dobj.specification.dataLevel": {"$in": {"$var": "dataLevel"}}},
							{"dobj.specificInfo.acquisition.station.name": {"$in": {"$var": "stations"}}},
							{"$or": [
								{"dobj.specificInfo.productionInfo.creator.self.uri": {"$in": {"$var": "contributors"}}},
								{"dobj.specificInfo.productionInfo.contributors.self.uri": {"$in": {"$var": "contributors"}}}
							]},
							{"$or": [
								{"dobj.specificInfo.acquisition.station.theme": {"$in": {"$var": "themes"}}},
								{"dobj.specificInfo.theme": {"$in": {"$var": "themes"}}}
							]},
					  ]
					}},
					{"$group": {
						"_id": {"_$concat": ["https://meta.icos-cp.eu/objects/", {"_$substr": ["$dobj.hash", 0, 24]}]},
						"fileName": {"_$first": "$dobj.fileName"},
						"specification": {"_$first": "$dobj.specification"},
						"count": {"_$sum": 1}
					}},

					{"$sort": {"count": -1}}
				]
			}, {
				"uri": "getSpecifications",
				"type": "pipeline",
				"stages":[
					{"_$group": {
						"_id": "$dobj.specification.self.uri",
						"label": {"_$first": "$dobj.specification.self.label"},
						"count": {"_$sum": 1}
					}},
					{"_$sort": {"count": -1}}
				]
			}, {
				"uri": "getFormats",
				"type": "pipeline",
				"stages":[
					{"_$group": {
							"_id": "$dobj.specification.format.uri",
							"label": {"_$first": "$dobj.specification.format.label"},
							"count": {"_$sum": 1}
						}
					}
				]
			}, {
				"uri": "getDataLevels",
				"type": "pipeline",
				"stages":[
					{"_$group": {
							"_id": "$dobj.specification.dataLevel",
							"label": {"_$first": "$dobj.specification.dataLevel"},
							"count": {"_$sum": 1}
						}
					}
				]
			}, {
				"uri": "getContributors",
				"type": "pipeline",
				"stages":[
					{
						"$project": {
							"contributors": {
								"_$concatArrays": [
									"$dobj.specificInfo.productionInfo.contributors",
									["$dobj.specificInfo.productionInfo.creator"]
								]
							}
						},
					}, {
						"$unwind" : "$contributors"
					},
					{"$group": {
							"_id": "$contributors.self.uri",
							"firstName": {"$first": "$contributors.firstName"},
							"lastName": {"$first": "$contributors.lastName"},
							"count": {"$sum": 1}
						}
					},
					{
						"$project": {
							"_id": 1,
							"label": {"$concat": ["$firstName", " ", "$lastName"]},
							"count": 1
						}
					}
					{"$sort": {"label": 1}}
				]
			}, {
				"uri": "getStations",
				"type": "pipeline",
				"stages":[
					{"$group": {
							"_id": "$dobj.specificInfo.acquisition.station.name",
							"label": {"$first": "$dobj.specificInfo.acquisition.station.name"},
							"count": {"$sum": 1}
						}
					},
					{"$sort": {"label": 1}}
				]
			}, {
				"uri": "getThemes",
				"type": "pipeline",
				"stages":[
					{"$match": {
						"$or": [
							{"dobj.specificInfo.acquisition.station.theme": {"$exists": 1}},
							{"dobj.specificInfo.theme": {"$exists": 1}}
						]
					}},
					{"$replaceRoot": {
						"newRoot": {
							"themes": {
								"$reduce": {
									"input": {
										"$concatArrays": [
											[{"$ifNull": ["$dobj.specificInfo.acquisition.station.theme", ""]}],
											[{"$ifNull": ["$dobj.specificInfo.theme", ""]}]
										]
									},
									"initialValue": "",
									"in": { "$concat" : ["$$value", "$$this"] }
								}
							}}
						}
					},
					{"$group": {
							"_id": "$themes",
							"label": {"$first": "$themes"},
							"count": {"$sum": 1}
						}
					},
					{"$sort": {"label": 1}}
				]
			}, {
				"uri": "perIp",
				"type": "pipeline",
				"stages":[
					{"$group": {
							"_id": "$ip",
							"count": {"$sum": 1},
							"bytes": {"$sum": "$dobj.size"}
						}
					},
					{"$project": {
							"ip": "$_id",
							"_id": 0,
							"count": 1,
							"megabytes": {"$divide": ["$bytes", 1000000]}
						}
					},
					{"$sort": {"count": -1}}
				]
			}]
		}
	}

	etcFacade {
		folder: "./fileStorage/etcFacadeStaging"
		secret: "dummy to be replaced" //common secret for station-specific password autogeneration
		stationOverrides{ //if some stations' passwords got compromised, for example.
			"FA-Lso": "p4ssw0rd"
		}
		testStation: "FA-Lso"
	}
}
